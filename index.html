<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>小小電路科學家</title>
    <link rel="stylesheet" href="style.css" />
    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#4facfe" />
    <link rel="apple-touch-icon" href="icon.svg" />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <div class="container">
      <!-- Start Screen Overlay -->
      <div id="start-screen" class="overlay">
        <div class="panel start-panel">
          <h1>小小電路科學家</h1>
          <p>探索電路的奧秘，或是挑戰你的知識！</p>
          <div class="mode-selection">
            <button id="btn-normal-mode" class="btn-primary-large">
              自由探索模式
            </button>
            <div class="challenge-option">
              <button id="btn-challenge-mode" class="btn-secondary-large">
                挑戰模式
              </button>
              <div class="difficulty-select">
                <label>題數:</label>
                <select id="challenge-count">
                  <option value="5">5 題</option>
                  <option value="10">10 題</option>
                  <option value="15">15 題</option>
                </select>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Challenge HUD (Hidden by default) -->
      <div id="challenge-hud" class="hidden">
        <div class="hud-top">
          <div class="hud-score">
            得分: <span id="score-val">0</span> / <span id="total-val">0</span>
          </div>
          <div class="hud-question">
            題目: <span id="question-text">請連接電路...</span>
          </div>
        </div>
        <!-- Buttons moved to sidebar -->
      </div>

      <!-- Results Screen (Hidden by default) -->
      <div id="results-screen" class="overlay hidden">
        <div class="panel results-panel">
          <h2>挑戰完成！</h2>
          <div class="final-score">
            總分: <span id="final-score-val">0</span>
          </div>
          
          <!-- Weakness Analysis -->
          <div id="weakness-report" class="weakness-container hidden">
              <h3>📊 弱點分析</h3>
              <div id="weakness-list"></div>
          </div>

          <div id="mistakes-list" class="mistakes-container"></div>
          <button id="btn-restart" class="btn-primary">回到主選單</button>
        </div>
      </div>
      <header>
        <h1>💡 小小電路科學家 🔋</h1>
        <p>拖曳電池和燈泡，把它們連起來看看會發生什麼事吧！</p>
      </header>

      <main>
        <div class="sidebar">
          <h2>元件箱</h2>
          <div class="toolbox">
            <div class="component-item" draggable="true" data-type="battery">
              <div class="icon battery-icon">🔋</div>
              <span>電池 (1.5V)</span>
            </div>
            <div class="component-item" draggable="true" data-type="bulb">
              <div class="icon bulb-icon">💡</div>
              <span>燈泡</span>
            </div>
            <div class="component-item" draggable="true" data-type="motor">
              <div class="icon motor-icon">⚙️</div>
              <span>馬達</span>
            </div>
            <div class="component-item" draggable="true" data-type="switch">
              <div class="icon switch-icon">
                <svg
                  width="40"
                  height="40"
                  viewBox="0 0 100 100"
                  style="overflow: visible"
                >
                  <circle cx="20" cy="80" r="10" fill="#95a5a6" />
                  <circle cx="80" cy="80" r="10" fill="#95a5a6" />
                  <line
                    x1="20"
                    y1="80"
                    x2="70"
                    y2="30"
                    stroke="#f39c12"
                    stroke-width="8"
                    stroke-linecap="round"
                  />
                  <rect
                    x="65"
                    y="25"
                    width="10"
                    height="20"
                    fill="#e74c3c"
                    transform="rotate(-45 70 30)"
                  />
                </svg>
              </div>
              <span>開關</span>
            </div>
            <!-- New Components -->
            <div class="component-item" draggable="true" data-type="paperclip">
              <div class="icon">📎</div>
              <span>迴紋針</span>
            </div>
            <div class="component-item" draggable="true" data-type="eraser">
              <div class="icon">🧼</div>
              <span>橡皮擦</span>
            </div>
            <div class="component-item" draggable="true" data-type="coin">
              <div class="icon">🪙</div>
              <span>硬幣</span>
            </div>
            <div class="component-item" draggable="true" data-type="lego">
              <div class="icon">
                <svg
                  width="40"
                  height="40"
                  viewBox="0 0 100 100"
                  style="overflow: visible"
                >
                  <!-- Red Body -->
                  <rect
                    x="15"
                    y="25"
                    width="70"
                    height="50"
                    rx="2"
                    fill="#e74c3c"
                    stroke="#c0392b"
                    stroke-width="2"
                  />
                  <!-- Studs (2x4) -->
                  <circle
                    cx="26"
                    cy="38"
                    r="6"
                    fill="#c0392b"
                    stroke="#e74c3c"
                    stroke-width="1"
                  />
                  <circle
                    cx="42"
                    cy="38"
                    r="6"
                    fill="#c0392b"
                    stroke="#e74c3c"
                    stroke-width="1"
                  />
                  <circle
                    cx="58"
                    cy="38"
                    r="6"
                    fill="#c0392b"
                    stroke="#e74c3c"
                    stroke-width="1"
                  />
                  <circle
                    cx="74"
                    cy="38"
                    r="6"
                    fill="#c0392b"
                    stroke="#e74c3c"
                    stroke-width="1"
                  />

                  <circle
                    cx="26"
                    cy="62"
                    r="6"
                    fill="#c0392b"
                    stroke="#e74c3c"
                    stroke-width="1"
                  />
                  <circle
                    cx="42"
                    cy="62"
                    r="6"
                    fill="#c0392b"
                    stroke="#e74c3c"
                    stroke-width="1"
                  />
                  <circle
                    cx="58"
                    cy="62"
                    r="6"
                    fill="#c0392b"
                    stroke="#e74c3c"
                    stroke-width="1"
                  />
                  <circle
                    cx="74"
                    cy="62"
                    r="6"
                    fill="#c0392b"
                    stroke="#e74c3c"
                    stroke-width="1"
                  />
                </svg>
              </div>
              <span>積木</span>
            </div>
          </div>

          <div class="sidebar-controls">
            <button id="verify-btn" class="btn success hidden">驗證答案</button>
            <button id="clear-btn" class="btn danger">清除全部</button>
            <button id="home-btn" class="btn home">回到首頁</button>
          </div>

          <div class="instructions">
            <h3>如何使用：</h3>
            <ol>
              <li>從元件箱把元件拖曳到右邊的畫布上。</li>
              <li>點擊元件兩端的接點來連接電線。</li>
              <li>按一下可以旋轉元件。</li>
              <li>右鍵或長按選單可刪除元件。</li>
            </ol>
          </div>
        </div>

        <div class="workspace-container">
          <canvas id="circuit-canvas"></canvas>
          <div id="short-warning" class="warning-banner hidden">
            ⚠️ 短路警告！電池過熱危險！
          </div>
          <div id="status-display">目前狀態: 等待連接...</div>

          <!-- Context Menu -->
          <div id="context-menu" class="hidden">
            <div class="menu-item" id="menu-resistance">電阻: --</div>
            <div class="menu-item" id="menu-voltage">跨壓: --</div>
            <div class="menu-item" id="menu-current">電流: --</div>
            <div class="menu-item hidden" id="menu-rpm">轉速: --</div>
            <div class="menu-item" id="menu-delete" style="color: #e74c3c; cursor: pointer; font-weight: bold; border-top: 1px solid #eee;">🗑️ 刪除元件</div>
          </div>
        </div>
      </main>
    </div>

    <script src="script.js"></script>
    <script>
      if ("serviceWorker" in navigator) {
        navigator.serviceWorker
          .register("./sw.js")
          .then(() => console.log("Service Worker Registered"))
          .catch((err) => console.log("SW Failed", err));
      }
    </script>
  </body>
</html>
